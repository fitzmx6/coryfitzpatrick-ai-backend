# Change the first line from:
FROM python:3.11-slim

# To explicitly use 3.11:
FROM python:3.11.9-slim-bookworm

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# Copy requirements first (for better caching)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application files
COPY server.py .
COPY prepare_data.py .
COPY training_data.jsonl .

# Start Ollama in background, pull model, and generate database
RUN ollama serve > /dev/null 2>&1 & \
    sleep 10 && \
    ollama pull llama3.1:8b && \
    python prepare_data.py

# Expose port
EXPOSE 8000

# Start both Ollama and server
CMD ["sh", "-c", "ollama serve > /dev/null 2>&1 & sleep 5 && python server.py"]