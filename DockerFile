FROM python:3.11-slim

WORKDIR /app

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# Copy requirements first (for better caching)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application files
COPY server.py .
COPY prepare_data.py .
COPY training_data.jsonl .

# Start Ollama in background and pull model
RUN ollama serve & sleep 10 && ollama pull llama3.1:8b

# Generate vector database
RUN python prepare_data.py

# Expose port
EXPOSE 8000

# Start both Ollama and server
CMD ["sh", "-c", "ollama serve & sleep 5 && python server.py"]