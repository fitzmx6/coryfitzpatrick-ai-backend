# nixpacks.toml

[phases.setup]
nixPkgs = ["curl", "bash", "python311"]

[phases.install]
cmds = [
    # 1. Create the Python virtual environment
    "python3.11 -m venv /opt/venv",
    
    # 2. Install all our Python packages
    "/opt/venv/bin/pip install -r requirements.txt",
    
    # 3. Install Ollama
    "curl -fsSL https://ollama.com/install.sh | sh",
    
    # 4. Start Ollama, pull the model, then stop Ollama
    # This MUST be one command to run in the same build layer
    """
    echo 'Starting Ollama service in background...' && \
    ollama serve & \
    OLLAMA_PID=$! && \
    echo 'Waiting for Ollama to be ready...' && \
    while ! curl -s http://localhost:11434/ > /dev/null; do sleep 1; done && \
    echo 'Ollama is ready. Pulling model: phi' && \
    ollama pull phi && \
    echo 'Model pulled. Stopping Ollama service...' && \
    kill $OLLAMA_PID
    """,

    # 5. Generate the vector database
    "echo 'Generating vector DB... this also happens once during build'",
    "/opt/venv/bin/python prepare_data.py"
]

[start]
cmd = "bash start.sh"